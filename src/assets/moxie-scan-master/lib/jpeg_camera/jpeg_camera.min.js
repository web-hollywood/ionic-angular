(function(){var t,e,i,s,o,a,r,n,_,h={}.hasOwnProperty,d=function(t,e){for(var i in e)h.call(e,i)&&(t[i]=e[i]);function s(){this.constructor=t}return s.prototype=e.prototype,t.prototype=new s,t.__super__=e.prototype,t};if(t=function(){function t(t,e){if("string"==typeof t&&(t=document.getElementById(t.replace("#",""))),!t||!t.offsetWidth)throw"JpegCamera: invalid container";t.innerHTML="",this.view_width=parseInt(t.offsetWidth,10),this.view_height=parseInt(t.offsetHeight,10),this.container=document.createElement("div"),this.container.style.width="100%",this.container.style.height="100%",this.container.style.position="relative",t.appendChild(this.container),this.options=this._extend({},this.constructor.DefaultOptions,e),this._engine_init()}return t.DefaultOptions={shutter_ogg_url:"/jpeg_camera/shutter.ogg",shutter_mp3_url:"/jpeg_camera/shutter.mp3",swf_url:"/jpeg_camera/jpeg_camera.swf",on_debug:function(t){if(console&&console.log)return console.log("JpegCamera: "+t)},quality:.9,shutter:!0,mirror:!0,timeout:0,retry_success:!1,scale:1},t._canvas_supported=!!document.createElement("canvas").getContext,t.canvas_supported=function(){return this._canvas_supported},t.prototype.ready=function(t){return this.options.on_ready=t,this.options.on_ready&&this._is_ready&&this.options.on_ready.call(this,{video_width:this.video_width,video_height:this.video_height}),this},t.prototype._is_ready=!1,t.prototype.error=function(t){return this.options.on_error=t,this.options.on_error&&this._error_occured&&this.options.on_error.call(this,this._error_occured),this},t.prototype._error_occured=!1,t.StatsCaptureScale=.2,t.prototype.get_stats=function(e){var i,o;return i=new s(this,{}),this._engine_capture(i,!1,.1,t.StatsCaptureScale),o=this,i.get_stats(function(t){return e.call(o,t)})},t.prototype.capture=function(t){var e,i,o;return null==t&&(t={}),i=new s(this,t),this._snapshots[i.id]=i,(o=i._options()).shutter&&this._engine_play_shutter_sound(),e=Math.min(1,o.scale),e=Math.max(.01,e),this._engine_capture(i,o.mirror,o.quality,e),i},t.prototype._snapshots={},t.prototype.stop=function(){},t.prototype.show_stream=function(){return this._engine_show_stream(),this._displayed_snapshot=null,this},t.prototype.discard_all=function(){var t,e,i;this._displayed_snapshot&&this.show_stream(),i=this._snapshots;for(t in i)e=i[t],this._engine_discard(e),e._discarded=!0;return this._snapshots={},this},t.prototype._extend=function(t){var e,i,s,o,a,r;for(a=0,r=(s=Array.prototype.slice.call(arguments,1)).length;a<r;a++)if(i=s[a])for(e in i)o=i[e],t[e]=o;return t},t.prototype._debug=function(t){if(this.options.on_debug)return this.options.on_debug.call(this,t)},t.prototype._display=function(t){return this._engine_display(t),this._displayed_snapshot=t},t.prototype._displayed_snapshot=null,t.prototype._discard=function(t){return this._displayed_snapshot===t&&this.show_stream(),this._engine_discard(t),t._discarded=!0,delete this._snapshots[t.id]},t.prototype._prepared=function(t,e){var i;return this.video_width=t,this.video_height=e,this._debug("Camera resolution "+this.video_width+"x"+this.video_height+"px"),i=this,setTimeout(function(){return i._wait_until_stream_looks_ok(!0)},1)},t.prototype._wait_until_stream_looks_ok=function(t){return this.get_stats(function(e){var i;return e.std>2?(this._debug("Stream mean gray value = "+e.mean+" standard deviation = "+e.std),this._debug("Camera is ready"),this._is_ready=!0,this.options.on_ready?this.options.on_ready.call(this,{video_width:this.video_width,video_height:this.video_height}):void 0):(t&&this._debug("Stream mean gray value = "+e.mean+" standard deviation = "+e.std),i=this,setTimeout(function(){return i._wait_until_stream_looks_ok(!1)},100))})},t.prototype._got_error=function(t){if(this._debug("Error - "+t),this._error_occured=t,this.options.on_error)return this.options.on_error.call(this,this._error_occured)},t.prototype._block_element_access=function(){return this._overlay=document.createElement("div"),this._overlay.style.width="100%",this._overlay.style.height="100%",this._overlay.style.position="absolute",this._overlay.style.top=0,this._overlay.style.left=0,this._overlay.style.zIndex=2,this.container.appendChild(this._overlay)},t.prototype._overlay=null,t.prototype.view_width=null,t.prototype.view_height=null,t._add_prefixed_style=function(t,e,i){var s;return s=e.charAt(0).toUpperCase()+e.slice(1),t.style[e]=i,t.style["Webkit"+s]=i,t.style["Moz"+s]=i,t.style["ms"+s]=i,t.style["O"+s]=i},t}(),navigator.getUserMedia||(navigator.getUserMedia=navigator.webkitGetUserMedia||navigator.mozGetUserMedia||navigator.msGetUserMedia),window.AudioContext||(window.AudioContext=window.webkitAudioContext),r=function(){var t;if((t=document.createElement("canvas")).getContext&&!t.toBlob)throw"JpegCamera: Canvas-to-Blob is not loaded"},navigator.getUserMedia&&(r(),_="audio/ogg; codecs=vorbis",n="audio/mpeg; ",a=function(t){var e;return!(!(e=document.createElement("video")).canPlayType||!e.canPlayType(t).replace(/no/,""))},i=function(e){function i(){return i.__super__.constructor.apply(this,arguments)}return d(i,t),i.prototype._engine_init=function(){var e,i,s,o,r,h;this._debug("Using HTML5 engine"),h=Math.floor(.2*this.view_height),s=Math.floor(.2*this.view_width),this.message=document.createElement("div"),this.message.class="message",this.message.style.width="100%",this.message.style.height="100%",t._add_prefixed_style(this.message,"boxSizing","border-box"),this.message.style.overflow="hidden",this.message.style.textAlign="center",this.message.style.paddingTop=h+"px",this.message.style.paddingBottom=h+"px",this.message.style.paddingLeft=s+"px",this.message.style.paddingRight=s+"px",this.message.style.position="absolute",this.message.style.zIndex=3,this.message.innerHTML="Please allow camera access when prompted by the browser.<br><br>Look for camera icon around your address bar.",this.container.appendChild(this.message),this.video_container=document.createElement("div"),this.video_container.style.width=this.view_width+"px",this.video_container.style.height=this.view_height+"px",this.video_container.style.overflow="hidden",this.video_container.style.position="absolute",this.video_container.style.zIndex=1,this.container.appendChild(this.video_container),this.video=document.createElement("video"),this.video.autoplay=!0,!1==!this.options.mirror&&t._add_prefixed_style(this.video,"transform","scalex(-1.0)"),window.AudioContext&&(a(_)?this._load_shutter_sound(this.options.shutter_ogg_url):a(n)&&this._load_shutter_sound(this.options.shutter_mp3_url)),i={video:{optional:[{minWidth:1280},{minWidth:640},{minWidth:480},{minWidth:360}]}},r=this,o=function(t){return r._remove_message(),r.activeTrack=t.getTracks()[0],window.URL?r.video.src=URL.createObjectURL(t):r.video.src=t,r._block_element_access(),r._wait_for_video_ready()},e=function(t){var e;r.message.innerHTML='<span style="color: red;">You have denied camera access.</span><br><br>Look for camera icon around your address bar to change your decision.',t.code;for(e in t)if(t[e],"code"!==e)return void r._got_error(e);return r._got_error("UNKNOWN ERROR")};try{return navigator.getUserMedia(i,o,e)}catch(t){return t,navigator.getUserMedia("video",o,e)}},i.prototype._engine_play_shutter_sound=function(){var t;if(this.shutter_buffer)return(t=this.audio_context.createBufferSource()).buffer=this.shutter_buffer,t.connect(this.audio_context.destination),t.start(0)},i.prototype._engine_capture=function(t,e,i,s){var o,a;return a=this._get_capture_crop(),(o=document.createElement("canvas")).width=Math.round(a.width*s),o.height=Math.round(a.height*s),o.getContext("2d").drawImage(this.video,a.x_offset,a.y_offset,a.width,a.height,0,0,Math.round(a.width*s),Math.round(a.height*s)),t._canvas=o,t._mirror=e,t._quality=i},i.prototype._engine_display=function(e){return this.displayed_canvas&&this.container.removeChild(this.displayed_canvas),this.displayed_canvas=e._canvas,this.displayed_canvas.style.width=this.view_width+"px",this.displayed_canvas.style.height=this.view_height+"px",this.displayed_canvas.style.top=0,this.displayed_canvas.style.left=0,this.displayed_canvas.style.position="absolute",this.displayed_canvas.style.zIndex=2,!1==!this.options.mirror&&t._add_prefixed_style(this.displayed_canvas,"transform","scalex(-1.0)"),this.container.appendChild(this.displayed_canvas)},i.prototype._engine_get_canvas=function(t){var e;return(e=document.createElement("canvas")).width=t._canvas.width,e.height=t._canvas.height,e.getContext("2d").drawImage(t._canvas,0,0),e},i.prototype._engine_get_image_data=function(t){var e;return(e=t._canvas).getContext("2d").getImageData(0,0,e.width,e.height)},i.prototype._engine_get_blob=function(t,e,i,s,o){var a,r;return i?((a=document.createElement("canvas")).width=t._canvas.width,a.height=t._canvas.height,(r=a.getContext("2d")).setTransform(1,0,0,1,0,0),r.translate(a.width,0),r.scale(-1,1),r.drawImage(t._canvas,0,0)):a=t._canvas,a.toBlob(function(t){return o(t)},e,s)},i.prototype._engine_discard=function(t){return t._xhr&&t._xhr.abort(),delete t._xhr,delete t._canvas},i.prototype.stop=function(){if(this.activeTrack)return this.activeTrack.stop()},i.prototype._engine_show_stream=function(){return this.displayed_canvas&&(this.container.removeChild(this.displayed_canvas),this.displayed_canvas=null),this.video_container.style.display="block"},i.prototype._engine_upload=function(t,e,i,s){return this._debug("Uploading the file"),t.get_blob(function(o){var a,r;return a=function(e){return delete t._xhr,t._status=e.target.status,t._response=e.target.responseText,t._status>=200&&t._status<300?t._upload_done():(t._error_message=e.target.statusText||"Unknown error",t._upload_fail())},(r=new XMLHttpRequest).open("POST",e),r.timeout=s,i&&r.setRequestHeader("X-CSRF-Token",i),r.onload=a,r.onerror=a,r.onabort=a,r.send(o),t._xhr=r},"image/jpeg")},i.prototype._remove_message=function(){return this.message.style.display="none"},i.prototype._load_shutter_sound=function(t){var e,i;if(!this.audio_context)return this.audio_context=new AudioContext,(e=new XMLHttpRequest).open("GET",t,!0),e.responseType="arraybuffer",i=this,e.onload=function(){return i.audio_context.decodeAudioData(e.response,function(t){return i.shutter_buffer=t})},e.send()},i.prototype._wait_for_video_ready=function(){var t,e,i,s;return s=parseInt(this.video.videoWidth),i=parseInt(this.video.videoHeight),s>0&&i>0?(this.video_container.appendChild(this.video),this.video_width=s,this.video_height=i,t=this._get_video_crop(),this.video.style.position="relative",this.video.style.width=t.width+"px",this.video.style.height=t.height+"px",this.video.style.left=t.x_offset+"px",this.video.style.top=t.y_offset+"px",this._prepared(this.video_width,this.video_height)):this._status_checks_count>100?this._got_error("Camera failed to initialize in 10 seconds"):(this._status_checks_count++,e=this,setTimeout(function(){return e._wait_for_video_ready()},100))},i.prototype._status_checks_count=0,i.prototype._get_video_crop=function(){var t,e,i;return this.video_width/this.video_height>=this.view_width/this.view_height?(this._debug("Filling height"),i=this.view_height/this.video_height,{width:e=Math.round(this.video_width*i),height:this.view_height,x_offset:-Math.floor((e-this.view_width)/2),y_offset:0}):(this._debug("Filling width"),i=this.view_width/this.video_width,t=Math.round(this.video_height*i),{width:this.view_width,height:t,x_offset:0,y_offset:-Math.floor((t-this.view_height)/2)})},i.prototype._get_capture_crop=function(){var t,e,i;return this.video_width/this.video_height>=(i=this.view_width/this.view_height)?{width:e=Math.round(this.video_height*i),height:this.video_height,x_offset:Math.floor((this.video_width-e)/2),y_offset:0}:(t=Math.round(this.video_width/i),{width:this.video_width,height:t,x_offset:0,y_offset:Math.floor((this.video_height-t)/2)})},i}(),window.JpegCamera=i),!window.swfobject)throw"JpegCamera: SWFObject is not loaded";(!window.JpegCamera||!window.AudioContext||window.jpeg_camera_force_flash)&&function(){return window.swfobject&&swfobject.hasFlashPlayerVersion("9")}()&&(e=function(e){function i(){return i.__super__.constructor.apply(this,arguments)}return d(i,t),i._send_message=function(t,e){var i,s;if(s=this._instances[parseInt(t)])return i=Array.prototype.slice.call(arguments,2),this.prototype[e].apply(s,i)},i._instances={},i._next_id=1,i.prototype._engine_init=function(){var t,e,i,s,o,a,r;if(this._debug("Using Flash engine"),this._id=this.constructor._next_id++,this.constructor._instances[this._id]=this,!(this.view_width<215||this.view_height<138))return a={loop:"false",allowScriptAccess:"always",allowFullScreen:"false",quality:"best",wmode:"opaque",menu:"false"},t={id:s="flash_object_"+this._id,align:"middle"},o={id:this._id,width:this.view_width,height:this.view_height,shutter_url:this.options.shutter_mp3_url},r=this,e=function(t){return t.success?(r._debug("Flash loaded"),r._flash=document.getElementById(s)):r._got_error("Flash loading failed.")},(i=document.createElement("div")).id="jpeg_camera_flash_"+this._id,i.style.width="100%",i.style.height="100%",this.container.appendChild(i),swfobject.embedSWF(this.options.swf_url,i.id,this.view_width,this.view_height,"9",null,o,a,t,e);this._got_error("camera is too small to display privacy dialog")},i.prototype._engine_play_shutter_sound=function(){return this._flash._play_shutter()},i.prototype._engine_capture=function(t,e,i,s){return this._flash._capture(t.id,e,i,s)},i.prototype._engine_display=function(t){return this._flash._display(t.id)},i.prototype._engine_get_canvas=function(t){var e;return t._image_data||(t._image_data=this._engine_get_image_data(t)),(e=document.createElement("canvas")).width=t._image_data.width,e.height=t._image_data.height,e.getContext("2d").putImageData(t._image_data,0,0),e},i.prototype._engine_get_image_data=function(e){var i,s,o,a,r,n,_,h,d,p,u,l;for(o=this._flash._get_image_data(e.id),t.canvas_supported()?((s=document.createElement("canvas")).width=o.width,s.height=o.height,d=s.getContext("2d").createImageData(o.width,o.height)):d={data:[],width:o.width,height:o.height},r=p=0,u=(l=o.data).length;p<u;r=++p)n=4*r,h=(_=l[r])>>16&255,a=_>>8&255,i=255&_,d.data[n+0]=h,d.data[n+1]=a,d.data[n+2]=i,d.data[n+3]=255;return d},i.prototype._engine_get_blob=function(t,e,i,s,o){var a,r;return t._extra_canvas||(t._extra_canvas=this._engine_get_canvas(t)),i?((a=document.createElement("canvas")).width=t._canvas.width,a.height=t._canvas.height,(r=a.getContext("2d")).setTransform(1,0,0,1,0,0),r.translate(a.width,0),r.scale(-1,1),r.drawImage(t._extra_canvas,0,0)):a=t._extra_canvas,a.toBlob(function(t){return o(t)},e,s)},i.prototype._engine_discard=function(t){return this._flash._discard(t.id)},i.prototype._engine_show_stream=function(){return this._flash._show_stream()},i.prototype._engine_upload=function(t,e,i,s){return this._flash._upload(t.id,e,i,s)},i.prototype._flash_prepared=function(t,e){return this._block_element_access(),document.body.tabIndex=0,document.body.focus(),this._prepared(t,e)},i.prototype._flash_upload_complete=function(t,e,i,s){var o;return t=parseInt(t),(o=this._snapshots[t])._status=parseInt(e),o._response=s,o._status>=200&&o._status<300?o._upload_done():(o._error_message=i,o._upload_fail())},i}(),window.JpegCamera=e),s=function(){function e(t,e){this.camera=t,this.options=e,this.id=this.constructor._next_snapshot_id++}return e._next_snapshot_id=1,e.prototype._discarded=!1,e.prototype.show=function(){return this._discarded&&raise("discarded snapshot cannot be used"),this.camera._display(this),this},e.prototype.hide=function(){return this.camera.displayed_snapshot()===this&&this.camera.show_stream(),this},e.prototype.get_stats=function(t){return this._discarded&&raise("discarded snapshot cannot be used"),this.get_image_data(function(e){return this._get_stats(e,t)})},e.prototype.get_canvas=function(e){var i;return this._discarded&&raise("discarded snapshot cannot be used"),t._canvas_supported,i=this,setTimeout(function(){return i._extra_canvas||(i._extra_canvas=i.camera._engine_get_canvas(i)),t._add_prefixed_style(i._extra_canvas,"transform","scalex(-1.0)"),e.call(i,i._extra_canvas)},1),!0},e.prototype._extra_canvas=null,e.prototype.get_blob=function(e,i){var s;return null==i&&(i="image/jpeg"),this._discarded&&raise("discarded snapshot cannot be used"),t._canvas_supported,s=this,setTimeout(function(){var t,o;return s._blob_mime!==i&&(s._blob=null),s._blob_mime=i,s._blob?e.call(s,s._blob):(t=s.options.mirror,o=s.options.quality,s.camera._engine_get_blob(s,i,t,o,function(t){return s._blob=t,e.call(s,s._blob)}))},1),!0},e.prototype._blob=null,e.prototype._blob_mime=null,e.prototype.get_image_data=function(t){var e;return this._discarded&&raise("discarded snapshot cannot be used"),e=this,setTimeout(function(){return e._image_data||(e._image_data=e.camera._engine_get_image_data(e)),t.call(e,e._image_data)},1),null},e.prototype._image_data=null,e.prototype.upload=function(t){var e;if(null==t&&(t={}),this._discarded&&raise("discarded snapshot cannot be used"),!this._uploading){if(this._uploading=!0,this._retry=1,this._upload_options=t,!(e=this._options()).api_url)throw this.camera._debug("Snapshot#upload called without valid api_url"),"Snapshot#upload called without valid api_url";return this._start_upload(e),this}this.camera._debug("Upload already in progress")},e.prototype._upload_options={},e.prototype._uploading=!1,e.prototype._retry=1,e.prototype.done=function(t){var e;return this._discarded&&raise("discarded snapshot cannot be used"),this._upload_options.on_upload_done=t,(e=this._options()).on_upload_done&&this._done&&e.on_upload_done.call(this,this._response),this},e.prototype._done=!1,e.prototype._response=null,e.prototype.fail=function(t){var e;return this._discarded&&raise("discarded snapshot cannot be used"),this._upload_options.on_upload_fail=t,(e=this._options()).on_upload_fail&&this._fail&&e.on_upload_fail.call(this,this._status,this._error_message,this._response),this},e.prototype._fail=!1,e.prototype._status=null,e.prototype._error_message=null,e.prototype.discard=function(){this.camera._discard(this),delete this._extra_canvas,delete this._image_data,delete this._blob},e.prototype._options=function(){return this.camera._extend({},this.camera.options,this.options,this._upload_options)},e.prototype._start_upload=function(t){var e;return e="string"==typeof t.csrf_token&&t.csrf_token.length>0?t.csrf_token:null,this._done=!1,this._response=null,this._fail=!1,this._status=null,this._error_message=null,this.camera._engine_upload(this,t.api_url,e,t.timeout)},e.prototype._get_stats=function(t,e){var i,s,a,r,n,_,h,d,p,u,l;if(!this._stats){for(_=t.width*t.height,h=0,s=new Array(_),a=p=0;p<_;a=p+=1)r=4*a,i=.2126*t.data[r+0]+.7152*t.data[r+1]+.0722*t.data[r+2],h+=i=Math.round(i),s[a]=i;for(n=Math.round(h/_),d=0,u=0,l=s.length;u<l;u++)i=s[u],d+=Math.pow(i-n,2);this._stats=new o,this._stats.mean=n,this._stats.std=Math.round(Math.sqrt(d/_))}return e.call(this,this._stats)},e.prototype._stats=null,e.prototype._upload_done=function(){var t,e,i,s;return this.camera._debug("Upload completed with status "+this._status),this._done=!0,!0===(i=(t=this._options()).retry_success&&t.retry_if&&t.retry_if.call(this,this._status,this._error_message,this._response,this._retry))&&(i=0),"number"==typeof i?(this._retry++,i>0?(e=parseInt(i),this.camera._debug("Will retry the upload in "+e+"ms (attempt #"+this._retry+")"),s=this,setTimeout(function(){return s._start_upload(t)},e)):(this.camera._debug("Will retry the upload immediately (attempt #"+this._retry+")"),this._start_upload(t))):(this._uploading=!1,t.on_upload_done?t.on_upload_done.call(this,this._response):void 0)},e.prototype._upload_fail=function(){var t,e,i,s;return this.camera._debug("Upload failed with status "+this._status),this._fail=!0,!0===(i=(t=this._options()).retry_if&&t.retry_if.call(this,this._status,this._error_message,this._response,this._retry))&&(i=0),"number"==typeof i?(this._retry++,i>0?(e=parseInt(i),this.camera._debug("Will retry the upload in "+e+"ms (attempt #"+this._retry+")"),s=this,setTimeout(function(){return s._start_upload(t)},e)):(this.camera._debug("Will retry the upload immediately (attempt #"+this._retry+")"),this._start_upload(t))):(this._uploading=!1,t.on_upload_fail?t.on_upload_fail.call(this,this._status,this._error_message,this._response):void 0)},e}(),o=function(){function t(){}return t.prototype.mean=null,t.prototype.std=null,t}()}).call(this);